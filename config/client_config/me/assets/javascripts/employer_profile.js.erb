var EmployerProfile = ( function( window, undefined ) {

  function changeCensusEmployeeStatus($thisObj) {
    $('.injected-edit-status').html('<br/><h3 class="no-buffer">'+$thisObj.text()+'</h3><div class="module change-employee-status hbx-panel panel panel-default"><div class="panel-body"><div class="vertically-aligned-row"><div><label class="enroll-label">Enter Date of '+$thisObj.text()+':</label><input title="&#xf073; &nbsp;" placeholder="&#xf073; &nbsp;'+$thisObj.text()+' Date" type="text" class="date-picker date-field form-control"/></div><div class="text-center"><span class="btn btn-primary btn-sm disabled">'+$thisObj.text()+'</span></div></div></div></div>');
    if ( $thisObj.text() == 'Terminate' ) {
        $('.injected-edit-status .change-employee-status label').text('Enter Date of Termination:')
      $('.injected-edit-status .change-employee-status .date-picker').attr('placeholder', $('.injected-edit-status .change-employee-status .date-picker').attr('title')+'Termination Date (must be within the past 60 days)');
      $('.injected-edit-status .change-employee-status label').text('Enter Date of Termination:')
    }
    $('.injected-edit-status').slideDown();
    $('.injected-edit-status .date-picker').on('change', function() {
      $(this).closest('.injected-edit-status').find('.btn-primary').removeClass('disabled');
      var url = $(this).closest('.census-employee').data('rehire-url');
      var rehiring_date = $(this).val();
      var status = $(this).closest('.census-employee').data('status');
      $(this).closest('.injected-edit-status').find('.btn-primary').off('click');
      $(this).closest('.injected-edit-status').find('.btn-primary:contains("Rehire")').on('click', function() {
        $.ajax({
          url: url,
          data: {
            rehiring_date: rehiring_date,
            status: status
          }
        })
      });
      $(this).closest('.injected-edit-status').find('.btn-primary:contains("Terminate")').on('click', function() {
        var url = $(this).closest('.census-employee').data('terminate-url');
        var termination_date = $('input[placeholder*="Termination Date"][title]').val();
        $.ajax({
          url: url,
          data: {
            termination_date: termination_date,
            status: status
          }
        })
      });
    });
  }

  function viewDetails($thisObj) {
    if ( $thisObj.hasClass('view') ) {
      $thisObj.closest('.benefit-package').find('.health-offering, .dental-offering').slideDown();
      $thisObj.html('Hide Details<i class="fa fa-chevron-up fa-lg"></i>');
      $thisObj.removeClass('view');
    } else {
      $thisObj.closest('.benefit-package').find('.health-offering, .dental-offering').slideUp();
      $thisObj.html('View Details<i class="fa fa-chevron-down fa-lg"></i>');
      $thisObj.addClass('view');
    }
  }

  function showActionNeeded(){
    $('.interaction-click-control-documents').html('Documents <span class="label label-danger">Action Needed</span>')
  }

  function validateEditPlanYear() {
    var minimumEmployerEmployeeContributionPct = $("input#employerMinEmployeeContribution").data('value');
    var minimumEmployerFamilyContributionPct = $("input#employerMinFamilyContribution").data('value');
    editbgtitles = $('.plan-title').find('label.title').parents('.form-group').find('input');
    editbgemployeepremiums = $('.benefits-fields').find('input[value=employee]').closest('fieldset').find('input.hidden-param.premium-storage-input');
    edit_all_premiums = $('.benefits-fields').find('input').closest('fieldset').find('input.hidden-param.premium-storage-input');
    editreferenceplanselections = $('.reference-plan input[type=radio]:checked');
    editselectedplan = $('input.ref-plan');

    var benefit_fields = $('.offerings .benefits-fields');
    if ($('.composite-offerings').is(':visible')) {
      benefit_fields = $('.composite-offerings .benefits-fields');
      editbgfamilypremiums = benefit_fields.find('input[value=family]').closest('fieldset').find('input.hidden-param.premium-storage-input');
      editbgemployeeonlypremiums = benefit_fields.find('input[value=employee_only]').closest('fieldset').find('input.hidden-param.premium-storage-input');
    } else {
        inputSpouceFieldset = $('.benefits-fields').find('input[value=spouse]').closest('fieldset')
        bgSpousePremiums = $(inputSpouceFieldset).find('input.hidden-param.premium-storage-input');
        spouseCheckbox = $(inputSpouceFieldset).find('input[type=checkbox]');

        inputDomesticPartnerFieldset = $('.benefits-fields').find('input[value=domestic_partner]').closest('fieldset')
        bgDomesticPartnerPremiums = $(inputDomesticPartnerFieldset).find('input.hidden-param.premium-storage-input');
        domesticPartnerCheckbox = $(inputDomesticPartnerFieldset).find('input[type=checkbox]');

        inputChildUnder26Fieldset = $('.benefits-fields').find('input[value=child_under_26]').closest('fieldset')
        bgChildUnder26Premiums = $(inputChildUnder26Fieldset).find('input.hidden-param.premium-storage-input');
        childUnder26Checkbox = $(inputChildUnder26Fieldset).find('input[type=checkbox]');
    }

        var editvalidatedbgfamilypremiums = false;
        var editValidatedbgSpousePremiums = false;
        var editValidatedbgDomesticPartnerPremiums = false;
        var editValidatedbgChildUnder26Premiums = false;

    editbgtitles.each(function() {
        editplantitle = $(this).val();
        if ( $(this).val().length > 0 && $('.plan-title input[value=' + "\"editplantitle\"" + ']').size() < 2 ) {
          editvalidatedbgtitles = true;
          editvalidated = true;
          var values = [];
          editbgtitles.each(function() {
              if ( $.inArray(this.value, values) >= 0 ) {
                $('.interaction-click-control-save-plan-year').attr('data-original-title', 'Before you can save, each benefit group must have a unique title.');
                editvalidatedbgtitles = false;
                editvalidated = false;
                return false; // <-- stops the loop
              } else {
                  values.push( this.value );
                  editvalidatedbgtitles = true;
                  editvalidated = true;
              }
          });
        } else {
          $('.interaction-click-control-save-plan-year').attr('data-original-title', 'Before you can save, each benefit group must have a unique title.');
          editvalidatedbgtitles = false;
          editvalidated = false;
          return false;
        }
    });

    if ( $('#plan_year_start_on').val() !== undefined && $('#plan_year_start_on').val().substring($('#plan_year_start_on').val().length - 5) == "01-01" ) {
      editvalidatedbgemployeepremiums = true;
      editvalidatedbgfamilypremiums = true;
      editValidatedbgSpousePremiums = true;
      editValidatedbgDomesticPartnerPremiums = true;
      editValidatedbgChildUnder26Premiums = true;
      editvalidated = true;
    } else {
      editbgemployeepremiums.each(function() {
        if ($('.composite-offerings').is(':visible')) {
          if ($('.family').is(':checked')) {
            editbgfamilypremiums.each(function() {
              if ( parseInt($(this).val()) >= parseInt(minimumEmployerFamilyContributionPct) ) {
                editvalidatedbgfamilypremiums = true;
                editvalidated = true;
              } else {
                $('.interaction-click-control-save-plan-year').attr('data-original-title', 'Employer premium contribution for Family Health Plans must be at least ' + minimumEmployerFamilyContributionPct + '%');
                editvalidatedbgfamilypremiums = false;
                editvalidated = false;
                return false;
              }
            });
          } else {
            editvalidatedbgfamilypremiums = true;
          }
          editbgemployeeonlypremiums.each(function() {
            if ( parseInt($(this).val()) >= parseInt(minimumEmployerEmployeeContributionPct) ) {
              editvalidatedbgemployeepremiums = true;
              editvalidated = true;
            } else {
              $('.interaction-click-control-save-plan-year').attr('data-original-title', '<%= Settings.plan_option_titles.plan_year_tooltip %> ' + minimumEmployerEmployeeContributionPct + '%');
              editvalidatedbgemployeepremiums = false;
              editvalidated = false;
              return false;
            }
          });
            editValidatedbgSpousePremiums = true;
            editValidatedbgDomesticPartnerPremiums = true;
            editValidatedbgChildUnder26Premiums = true;
        } else {
            if ($(spouseCheckbox).is(':checked')) {
                bgSpousePremiums.each(function() {
                    if ( parseInt($(this).val()) >= parseInt(minimumEmployerFamilyContributionPct) ) {
                        editValidatedbgSpousePremiums = true;
                        editvalidated = true;
                    } else {
                        $('.interaction-click-control-create-plan-year').attr('data-original-title', 'Employer premium contribution for Spouse Health Plans must be at least ' + minimumEmployerFamilyContributionPct + '%');
                        editValidatedbgSpousePremiums = false;
                        editvalidated = false;
                        return false;
                    }
                });
            } else {
                editValidatedbgSpousePremiums = true;
            }

            if ($(domesticPartnerCheckbox).is(':checked')) {
                bgDomesticPartnerPremiums.each(function() {
                    if ( parseInt($(this).val()) >= parseInt(minimumEmployerFamilyContributionPct) ) {
                        editValidatedbgDomesticPartnerPremiums = true;
                        editvalidated = true;
                    } else {
                        $('.interaction-click-control-create-plan-year').attr('data-original-title', 'Employer premium contribution for Domestic Partner Health Plans must be at least ' + minimumEmployerFamilyContributionPct + '%');
                        editValidatedbgDomesticPartnerPremiums = false;
                        editvalidated = false;
                        return false;
                    }
                });
            } else {
                editValidatedbgDomesticPartnerPremiums = true;
            }

            if ($(childUnder26Checkbox).is(':checked')) {
                bgChildUnder26Premiums.each(function() {
                    if ( parseInt($(this).val()) >= parseInt(minimumEmployerFamilyContributionPct) ) {
                        editValidatedbgChildUnder26Premiums = true;
                        editvalidated = true;
                    } else {
                        $('.interaction-click-control-create-plan-year').attr('data-original-title', 'Employer premium contribution for Child Under 26 Health Plans must be at least ' + minimumEmployerFamilyContributionPct + '%');
                        editValidatedbgChildUnder26Premiums = false;
                        editvalidated = false;
                        return false;
                    }
                });
            } else {
                editValidatedbgChildUnder26Premiums = true;
            }

          if ( $(this).closest('.benefit-group-fields').hasClass('edit-additional') && $(this).closest('.select-fs-plan').length ) {
          } else {
            if ( parseInt($(this).val() ) >= parseInt(minimumEmployerEmployeeContributionPct) ) {
              editvalidatedbgemployeepremiums = true
              editvalidatedbgfamilypremiums = true;
              editvalidated = true;
            } else {

              $('.interaction-click-control-save-plan-year').attr('data-original-title', 'Employer premium contribution for Health Plans must be at least ' + minimumEmployerEmployeeContributionPct + '%');
              editvalidatedbgemployeepremiums = false;
              editvalidated = false;
              return false;
            }
          }
        }
      });
    }
    if ( editreferenceplanselections.length != $('.benefit-group-fields').length ) {
      editvalidatedreferenceplanselections = true
      editvalidated = true;
    } else {
      editbgemployeepremiums.each(function() {
        if ($('.composite-offerings').is(':visible')) {
          editbgfamilypremiums.each(function() {
            if ( parseInt($(this).val()) >= parseInt(minimumEmployerFamilyContributionPct) ) {
              editvalidatedbgfamilypremiums = true;
              editvalidated = true;
            } else {
              $('.interaction-click-control-save-plan-year').attr('data-original-title', 'Employer premium contribution for Family Health Plans must be at least ' + minimumEmployerFamilyContributionPct + '%');
              editvalidatedbgfamilypremiums = false;
              editvalidated = false;
              return false;
            }
          });
          editbgemployeeonlypremiums.each(function() {
            if ( parseInt($(this).val()) >= parseInt(minimumEmployerEmployeeContributionPct) ) {
              editvalidatedbgemployeepremiums = true;
              editvalidated = true;
            } else {
              $('.interaction-click-control-save-plan-year').attr('data-original-title', '<%= Settings.plan_option_titles.plan_year_tooltip %> ' + minimumEmployerEmployeeContributionPct + '%');
              editvalidatedbgemployeepremiums = false;
              editvalidated = false;
              return false;
            }
          });
        } else {
          if ( $(this).closest('.benefit-group-fields').hasClass('edit-additional') && $(this).closest('.select-dental-plan').length ) {
          } else {
            if ( parseInt($(this).val() ) >= parseInt(minimumEmployerEmployeeContributionPct) ) {
              editvalidatedbgemployeepremiums = true
              validatedbgfamilypremiums = true

              editvalidated = true;
            } else {

              $('.interaction-click-control-save-plan-year').attr('data-original-title', 'Employer premium contribution for Health Plans must be at least ' + minimumEmployerEmployeeContributionPct + '%');
              editvalidatedbgemployeepremiums = false;
              editvalidated = false;
              return false;
            }
          }
        }
      });
    }

    edit_all_premiums.each(function() {
      if ( parseInt($(this).val()) >= parseInt(0) && parseInt($(this).val()) <= parseInt(100)) {
        edit_validated_all_premiums = true;
        editvalidated = true;
      } else {
        $('.interaction-click-control-save-plan-year').attr('data-original-title', 'Premium contribution amounts must be between 0 and 100%');
        edit_validated_all_premiums = false;
        editvalidated = false;
        return false;
      }
    });

    $('.benefit-group-fields').each(function() {
      if ( $(this).hasClass('edit-additional') ) {
        if ( $(this).find('.reference-steps:first').is(':visible') && $(this).find('.reference-steps:first').find('input:checked').length >= 4 ) {
         editvalidatedreferenceplanselections = true
          editvalidated = true;
        } else if ( $(this).find('.reference-steps:first').is(':hidden')) {
            editvalidatedreferenceplanselections = true
            editvalidated = true;
        }
          else {
            $('.interaction-click-control-save-plan-year').attr('data-original-title', "Before you can save, you must finish your plan year selection. Click 'Cancel' above to keep your existing selection");
            editvalidatedreferenceplanselections = false
            editvalidated = false;
            return false;
        }
      } else {
      if ( $(this).find('.reference-steps').is(':first') ) {
        if ( $(this).find('.reference-steps:first').is(':visible') && $(this).find('.reference-steps:first').find('input:checked').length >= 4 ) {
         editvalidatedreferenceplanselections = true
          editvalidated = true;
        } else if ( $(this).find('.reference-steps:first').is(':hidden')) {
            editvalidatedreferenceplanselections = true
            editvalidated = true;
        }
          else {
            $('.interaction-click-control-save-plan-year').attr('data-original-title', "Before you can save, you must finish your plan year selection. Click 'Cancel' above to keep your existing selection");
            editvalidatedreferenceplanselections = false
            editvalidated = false;
            return false;
        }
      } else {
        if ( $(this).find('.reference-steps:last').find('.edit-add-dental').length ) {
          if ( $('.edit-add-dental').is(':hidden') ) {
            if ( $(this).find('.reference-steps:last').find('.plan-options').is(':hidden') && $(this).find('.reference-steps:last').find('.nav-tabs').is(':hidden') && $(this).find('.reference-steps:last').find('.dental-reference-plans').is(':hidden')) {
              editvalidatedreferenceplanselections = true
              editvalidated = true;
            } else if ( $(this).find('.reference-steps:last').is(':hidden')) {
                editvalidatedreferenceplanselections = true
                editvalidated = true;
            }
              else {
                $('.interaction-click-control-save-plan-year').attr('data-original-title', "Before you can save, you must finish your plan year selection. Click 'Cancel' above to keep your existing selection");
                editvalidatedreferenceplanselections = false
                editvalidated = false;
                return false;
            }
          }

        } else {
          if ( $(this).find('.reference-steps:last').find('.plan-options').is(':hidden') && $(this).find('.reference-steps:last').find('.nav-tabs').is(':hidden') && $(this).find('.reference-steps:last').find('.dental-reference-plans').is(':hidden')) {
            editvalidatedreferenceplanselections = true
            editvalidated = true;
          }   else {
                $('.interaction-click-control-save-plan-year').attr('data-original-title', "Before you can save, you must finish your plan year selection. Click 'Cancel' above to keep your existing selection");
                editvalidatedreferenceplanselections = false
                editvalidated = false;
                return false;
          }
        }
      }
    }
    });

      if ( editvalidatedbgtitles && editvalidatedbgemployeepremiums && editvalidatedreferenceplanselections && edit_validated_all_premiums && editvalidatedbgfamilypremiums && editValidatedbgSpousePremiums && editValidatedbgDomesticPartnerPremiums && editValidatedbgChildUnder26Premiums) {
        $('.interaction-click-control-save-plan-year').removeAttr('data-original-title');
        $('.interaction-click-control-save-plan-year').removeClass('disabled');
        $('.interaction-click-control-save-plan-year').removeAttr('disabled');

        $('.interaction-click-control-save-plan-year').attr('data-original-title', 'Click here to save your plan year');
      } else {
        $('.interaction-click-control-save-plan-year').addClass('disabled');
        $('.interaction-click-control-save-plan-year').attr('disabled', true);
      }
      Freebies.tooltip();
  }

  function validatePlanYear() {
    var minimumEmployerEmployeeContributionPct = $("input#employerMinEmployeeContribution").data('value');
    var minimumEmployerFamilyContributionPct = $("input#employerMinFamilyContribution").data('value');
    var validatedbgfamilypremiums = false;
    var validatedbgSpousePremiums = false;
    var validatedbgDomesticPartnerPremiums = false;
    var validatedbgChildUnder26Premiums = false;

    bgtitles = $('.plan-title').find('label.title').parents('.form-group').find('input');
    bgemployeepremiums = $('.benefits-fields').find('input[value=employee]').closest('fieldset').find('input.hidden-param.premium-storage-input');

    bgemployeeonlypremiums = $('.benefits-fields').find('input[value=employee_only]').closest('fieldset').find('input.hidden-param.premium-storage-input');
    bgfamilypremiums = $('.benefits-fields').find('input[value=family]').closest('fieldset').find('input.hidden-param.premium-storage-input');

    inputSpouceFieldset = $('.benefits-fields').find('input[value=spouse]').closest('fieldset')
    bgSpousePremiums = $(inputSpouceFieldset).find('input.hidden-param.premium-storage-input');
    spouseCheckbox = $(inputSpouceFieldset).find('input[type=checkbox]');

    inputDomesticPartnerFieldset = $('.benefits-fields').find('input[value=domestic_partner]').closest('fieldset')
    bgDomesticPartnerPremiums = $(inputDomesticPartnerFieldset).find('input.hidden-param.premium-storage-input');
    domesticPartnerCheckbox = $(inputDomesticPartnerFieldset).find('input[type=checkbox]');

    inputChildUnder26Fieldset = $('.benefits-fields').find('input[value=child_under_26]').closest('fieldset')
    bgChildUnder26Premiums = $(inputChildUnder26Fieldset).find('input.hidden-param.premium-storage-input');
    childUnder26Checkbox = $(inputChildUnder26Fieldset).find('input[type=checkbox]');

    all_premiums = $('.benefits-fields').find('input').closest('fieldset').find('input.hidden-param.premium-storage-input');
    referenceplanselections = $('.reference-plan input[type=radio]:checked');
    bgtitles.each(function() {
      plantitle = $(this).val();
      if ( $(this).val().length > 0 && $('.plan-title input[value=' + "\"plantitle\"" + ']').size() < 2 ) {
        validatedbgtitles = true;
        validated = true;
        var values = [];
        bgtitles.each(function() {
            if ( $.inArray(this.value, values) >= 0 ) {

              $('.interaction-click-control-create-plan-year').attr('data-original-title', 'Before you can save, each benefit group must have a unique title.');
              validatedbgtitles = false;
              validated = false;
              return false; // <-- stops the loop
            } else {
                values.push( this.value );
                validatedbgtitles = true;
                validated = true;
            }
        });
      } else {
        $('.interaction-click-control-create-plan-year').attr('data-original-title', 'Before you can save, each benefit group must have a unique title.');
        validatedbgtitles = false;
        validated = false;
        return false;
      }
    });
    if ( $('#plan_year_start_on').val() !== undefined && $('#plan_year_start_on').val().substring($('#plan_year_start_on').val().length - 5) == "01-01" ) {
      validatedbgemployeepremiums = true;
      validatedbgfamilypremiums = true;
      validatedbgSpousePremiums = true;
      validatedbgDomesticPartnerPremiums = true;
      validatedbgChildUnder26Premiums = true;
      validated = true;
    } else {
      bgemployeepremiums.each(function() {
        if ($('.composite-offerings').is(":visible")) {
          if ($('.family').is(':checked')) {
            bgfamilypremiums.each(function() {
              if ( parseInt($(this).val()) >= parseInt(minimumEmployerFamilyContributionPct) ) {
                validatedbgfamilypremiums = true;
                validated = true;
              } else {
                $('.interaction-click-control-create-plan-year').attr('data-original-title', 'Employer premium contribution for Family Health Plans must be at least ' + minimumEmployerFamilyContributionPct + '%');
                validatedbgfamilypremiums = false;
                validated = false;
                return false;
              }
            });
          } else {
            validatedbgfamilypremiums = true;
          }

          bgemployeeonlypremiums.each(function() {
            if ( parseInt($(this).val()) >= parseInt(minimumEmployerEmployeeContributionPct) ) {
              validatedbgemployeepremiums = true;
              validated = true;
            } else {
              $('.interaction-click-control-create-plan-year').attr('data-original-title', '<%= Settings.plan_option_titles.plan_year_tooltip %> ' + minimumEmployerEmployeeContributionPct + '%');
              validatedbgemployeepremiums = false;
              validated = false;
              return false;
            }
          });
            validatedbgSpousePremiums = true;
            validatedbgDomesticPartnerPremiums = true;
            validatedbgChildUnder26Premiums = true;
        } else {

            if ($(spouseCheckbox).is(':checked')) {
                bgSpousePremiums.each(function() {
                    if ( parseInt($(this).val()) >= parseInt(minimumEmployerFamilyContributionPct) ) {
                        validatedbgSpousePremiums = true;
                        validated = true;
                    } else {
                        $('.interaction-click-control-create-plan-year').attr('data-original-title', 'Employer premium contribution for Spouse Health Plans must be at least ' + minimumEmployerFamilyContributionPct + '%');
                        validatedbgSpousePremiums = false;
                        validated = false;
                        return false;
                    }
                });
            } else {
                validatedbgSpousePremiums = true;
            }

            if ($(domesticPartnerCheckbox).is(':checked')) {
                bgDomesticPartnerPremiums.each(function() {
                    if ( parseInt($(this).val()) >= parseInt(minimumEmployerFamilyContributionPct) ) {
                        validatedbgDomesticPartnerPremiums = true;
                        validated = true;
                    } else {
                        $('.interaction-click-control-create-plan-year').attr('data-original-title', 'Employer premium contribution for Domestic Partner Health Plans must be at least ' + minimumEmployerFamilyContributionPct + '%');
                        validatedbgDomesticPartnerPremiums = false;
                        validated = false;
                        return false;
                    }
                });
            } else {
                validatedbgDomesticPartnerPremiums = true;
            }

            if ($(childUnder26Checkbox).is(':checked')) {
                bgChildUnder26Premiums.each(function() {
                    if ( parseInt($(this).val()) >= parseInt(minimumEmployerFamilyContributionPct) ) {
                        validatedbgChildUnder26Premiums = true;
                        validated = true;
                    } else {
                        $('.interaction-click-control-create-plan-year').attr('data-original-title', 'Employer premium contribution for Child Under 26 Health Plans must be at least ' + minimumEmployerFamilyContributionPct + '%');
                        validatedbgChildUnder26Premiums = false;
                        validated = false;
                        return false;
                    }
                });
            } else {
                validatedbgChildUnder26Premiums = true;
            }

            if ( parseInt($(this).val()) >= parseInt(minimumEmployerEmployeeContributionPct) ) {
            validatedbgemployeepremiums = true;
            validatedbgfamilypremiums = true
            validated = true;
          } else {
            $('.interaction-click-control-create-plan-year').attr('data-original-title', '<%= Settings.plan_option_titles.plan_year_tooltip %> ' + minimumEmployerEmployeeContributionPct + '%');
            validatedbgemployeepremiums = false;
            validated = false;
            return false;
          }
        }
      });
    }

    all_premiums.each(function() {
      if ( parseInt($(this).val()) >= parseInt(0) && parseInt($(this).val()) <= parseInt(100)) {
        validated_all_premiums = true;
        validated = true;
      } else {
        $('.interaction-click-control-create-plan-year').attr('data-original-title', 'Premium contribution amounts must be between 0 and 100%');
        validated_all_premiums = false;
        validated = false;
        return false;
      }
    });

    dental_bgs = $('.select-dental-plan:visible').length
    health_bgs = $('.benefit-group-fields > .health.offerings-slider:visible').length
    selected_reference_plans = dental_bgs + health_bgs;
    validatedreferenceplanselections = false;
    if ( referenceplanselections.length != selected_reference_plans ) {
      validatedreferenceplanselections = false;
      validated = false;
    } else {
      referenceplanselections.each(function() {
        if ( $(this).length && $(this).val() != 'undefined' ) {
          validatedreferenceplanselections = true;
          validated = true;
        } else {
          $('.interaction-click-control-create-plan-year').attr('data-original-title', 'Each benefit group is required to have a reference plan selection before it can be saved');
          validatedreferenceplanselections = false
          validated = false;
          return false;
        }
      });
    }

      if (validatedbgtitles && validatedbgemployeepremiums && validatedbgfamilypremiums && validatedreferenceplanselections && validated_all_premiums && validatedbgSpousePremiums && validatedbgDomesticPartnerPremiums && validatedbgChildUnder26Premiums) {
        $('.interaction-click-control-create-plan-year').removeClass('disabled');
        $('.interaction-click-control-save-plan-year').removeAttr('disabled');

        $('.interaction-click-control-create-plan-year').removeAttr('data-original-title');
        $('.interaction-click-control-create-plan-year').attr('data-original-title', 'Click here to create your plan year');
        $('.interaction-click-control-create-plan-year').unbind('click');
      } else {
        $('.interaction-click-control-create-plan-year').addClass('disabled');
        $('.interaction-click-control-save-plan-year').attr('disabled', true);

        $('.interaction-click-control-create-plan-year').click(function(event){
          event.preventDefault();
        });
      }
      Freebies.tooltip();
  }

  function validateCobraBeginDate() {
    var hired_on_str = $('#census_employee_hired_on_jq_datepicker_plain_field').val();
    var cobra_begin_date_str = $('#census_employee_cobra_begin_date_jq_datepicker_plain_field').val();
    if($('#census_employee_existing_cobra').prop("checked") == true){
      if (hired_on_str != '' && cobra_begin_date_str != ''){
        var hired_on = new Date(hired_on_str);
        var cobra_begin_date = new Date(cobra_begin_date_str);
        if (hired_on > cobra_begin_date) {
          alert('Hire Date must be before Cobra Begin Date.');
        }
      }
    }
  }

  function submitCobraDate(cobra_date, cobra_link) {
    $.ajax({
      type: 'get',
      datatype : 'js',
      url: cobra_link,
      data: {cobra_date: cobra_date},
    });
  }

  function viewCobraDateField() {
    var target = $('#census_employee_existing_cobra');
    if(target.prop("checked") == true){
      target.parents('#cobra_info').find('#cobra_begin_date_field').removeClass('hidden');
    }else if(target.prop("checked") == false){
      target.parents('#cobra_info').find('#cobra_begin_date_field').addClass('hidden');
    }
  }

  return {
      changeCensusEmployeeStatus: changeCensusEmployeeStatus,
      validateEditPlanYear : validateEditPlanYear,
      validatePlanYear : validatePlanYear,
      validateCobraBeginDate : validateCobraBeginDate,
      viewDetails : viewDetails,
      viewCobraDateField: viewCobraDateField,
      showActionNeeded : showActionNeeded,
      submitCobraDate : submitCobraDate,
    };

} )( window );

// $(document).ready(function() {
//   if ('input.typeahead') {
//     var employers = new Bloodhound({
//       datumTokenizer: Bloodhound.tokenizers.obj.whitespace('legal_name'),
//       queryTokenizer: Bloodhound.tokenizers.whitespace,
//       remote: {
//         prepare: function (query, settings) {
//           settings.type = "POST";
//           settings.data = { q: query };
//           return settings;
//         },
//         url: '/employers/search'
//       }
//     });
//
//     // initialize the bloodhound suggestion engine
//     employers.initialize();
//     // instantiate the typeahead UI
//     $('input.typeahead').typeahead({
//       hint: false,
//       minLength: 2
//     },{
//       display: 'legal_name',
//       name: 'employers',
//       source: employers.ttAdapter()
//     });
//
//     $('input.typeahead').on('blur keyup', function(e) {
//       if (e.keyCode == 8 && $('input#organization_fein').val() != "") {
//         $('#office_locations_buttons a.btn').removeAttr('disabled');
//         $('input#employer_id').val("");
//         $('input#organization_dba').val("").removeAttr('readonly');
//         $('input#organization_fein').val("").removeAttr('readonly');
//         $('select#organization_entity_kind').val("").removeAttr('disabled').selectric('refresh');
//         $('select#organization_office_locations_attributes_0_address_attributes_kind').val("primary").removeAttr('disabled').selectric('refresh');
//         $('input#organization_office_locations_attributes_0_address_attributes_address_1').val("").removeAttr('readonly');
//         $('input#organization_office_locations_attributes_0_address_attributes_address_2').val("").removeAttr('readonly');
//         $('input#organization_office_locations_attributes_0_address_attributes_city').val("").removeAttr('readonly');
//         $('select#organization_office_locations_attributes_0_address_attributes_state').val("").removeAttr('disabled').selectric('refresh');
//         $('input#organization_office_locations_attributes_0_address_attributes_zip').val("").removeAttr('readonly');
//
//         $('input#organization_office_locations_attributes_0_phone_attributes_area_code').val("").removeAttr('readonly');
//         $('input#organization_office_locations_attributes_0_phone_attributes_number').val("").removeAttr('readonly');
//         $('input#organization_office_locations_attributes_0_phone_attributes_extension').val("").removeAttr('readonly');
//       };
//     });
//
//     $('input.typeahead').bind('typeahead:select', function(e, suggestion) {
//
//       $('#office_locations_buttons a.btn').attr('disabled', 'disabled');
//       $('input#employer_id').val(suggestion._id);
//       $('input#organization_dba').val(suggestion.dba).attr('readonly', 'readonly');
//       $('input#organization_fein').val(suggestion.fein).attr('readonly', 'readonly');
//       $('select#organization_entity_kind').val(suggestion.employer_profile.entity_kind).attr('disabled', 'disabled').selectric('refresh').removeAttr('disabled');
//       var primary_office = suggestion.office_locations[0]
//       if (primary_office) {
//         $('select#organization_office_locations_attributes_0_address_attributes_kind').val(primary_office.address.kind).attr('disabled', 'disabled').selectric('refresh').removeAttr('disabled');
//         $('input#organization_office_locations_attributes_0_address_attributes_address_1').val(primary_office.address.address_1).attr('readonly', 'readonly');
//         $('input#organization_office_locations_attributes_0_address_attributes_address_2').val(primary_office.address.address_2).attr('readonly', 'readonly');
//         $('input#organization_office_locations_attributes_0_address_attributes_city').val(primary_office.address.city).attr('readonly', 'readonly');
//         $('select#organization_office_locations_attributes_0_address_attributes_state').val(primary_office.address.state).attr('disabled', 'disabled').selectric('refresh').removeAttr('disabled');
//         $('input#organization_office_locations_attributes_0_address_attributes_zip').val(primary_office.address.zip).attr('readonly', 'readonly');
//
//         $('input#organization_office_locations_attributes_0_phone_attributes_area_code').val(primary_office.phone.area_code).attr('readonly', 'readonly');
//         $('input#organization_office_locations_attributes_0_phone_attributes_number').val(primary_office.phone.number).attr('readonly', 'readonly');
//         $('input#organization_office_locations_attributes_0_phone_attributes_extension').val(primary_office.phone.extension).attr('readonly', 'readonly');
//       }
//     });
//   }
// });

$(function() {
  $('div[name=employee_family_tabs] > ').children().each( function() {
    $(this).change(function(){
      filter = $(this).val();
      search = $("#census_employee_search input#employee_search").val();
      $('#employees_' + filter).siblings().hide();
      $('#employees_' + filter).show();
      $.ajax({
        url: $('span[name=employee_families_url]').text() + '.js',
        type: "GET",
        data : { 'status': filter, 'employee_search': search },
        crossDomain: true,
        xhrFields: {
          withCredentials: true
        },
        success: function (data) {
          $("#status").val(filter);
          $("#filter-span").text(filter);
        }
      });
    })
  })
})

$(document).on('click', "a.terminate.cancel", function(){
    $('tr.child-row:visible').remove();
    $("li>a:contains('Collapse Form')").addClass('disabled');
});

$(document).on('click', "a.cobra.cancel", function(){
    $('tr.child-row:visible').remove();
    $("li>a:contains('Collapse Form')").addClass('disabled');
});

$(document).on('click', "a.rehire.cancel", function(){
    $('tr.child-row:visible').remove();
    $("li>a:contains('Collapse Form')").addClass('disabled');
});

$(document).on('click', "a.interaction-click-control-terminate", function(){
  event.preventDefault();
    $('tr.child-row:visible').remove();
    $("li>a:contains('Collapse Form')").addClass('disabled');
});

$(document).on('click', '.cobra_confirm', function(event){
  event.preventDefault();
  var datepicker = $(this).prev();
  var cobra_date = datepicker.val();
  var cobra_link = $(this).data('link');
  // var target = $("tr."+type+'_'+ce_id);
  // var cobra_date = target.find('input.date-picker').val();
  // var cobra_link = target.find('a.cobra_confirm_submit').data('link');
  EmployerProfile.submitCobraDate(cobra_date, cobra_link);
})

$(document).on('click', ".delete_confirm", function(){
  var termination_date = $(this).closest('div').find('input').val();
  var link_to_delete = $(this).data('link');

  $.ajax({
    type: 'get',
    datatype : 'js',
    url: link_to_delete,
    data: {termination_date: termination_date},
    success: function(response){

        window.location.reload();

    },
    error: function(response){
      Alert("Sorry, something went wrong");
    }
  });
});

$(document).on('click', ".rehire-confirm", function(){
  var element_id = $(this).attr('id');
  var rehiring_date = $(this).siblings().val();
  var rehire_link = $(this).data('link');
  $.ajax({
    type: 'get',
    datatype : 'js',
    url: rehire_link,
    data: {rehiring_date: rehiring_date},
    success: function(response){
        window.location.reload();
    },
    error: function(response){
      Alert("Sorry, something went wrong");
    }
  });
});


$(document).on('change', '.dependent_info input.dob-picker', function(){
  var element = $(this).val().split("/");
  year = parseInt(element[2]);
  month = parseInt(element[0]);
  day = parseInt(element[1]);
  var mydate = dchbx_enroll_date_of_record();
  mydate.setFullYear(year + 26,month-1,day);
  var target = $(this).parents('.dependent_info').find('select');
  selected_option_index = $(target).get(0).selectedIndex

  if (mydate > dchbx_enroll_date_of_record()){
    data = "<option value=''>SELECT RELATIONSHIP</option><option value='spouse'>Spouse</option><option value='domestic_partner'>Domestic partner</option><option value='child_under_26'>Child</option>";
  }else{
    data = "<option value=''>SELECT RELATIONSHIP</option><option value='spouse'>Spouse</option><option value='domestic_partner'>Domestic partner</option><option value='child_26_and_over'>Child</option>";
  }
  $(target).html(data);
  $(target).prop('selectedIndex', selected_option_index).selectric('refresh');
});

$(function() {
  $("#publishPlanYear .close").click(function(){
    location.reload();
  });
  setProgressBar();
})

function setProgressBar(){

    // ignore this call by returning if no presense of progress-wrapper and employer-dummy classes
    if($('.progress-wrapper.employer-dummy').length == 0) {
      return;
    }



  maxVal = parseInt($('.progress-val .pull-right').data('value'));
  dividerVal = parseInt($('.divider-progress').data('value'));
  currentVal = parseInt($('.progress-bar').data('value'));
  percentageDivider = dividerVal/maxVal * 100;
  percentageCurrent = currentVal/maxVal * 100;

  $('.progress-bar').css({'width': percentageCurrent + "%"});
  $('.divider-progress').css({'left': (percentageDivider - 1) + "%"});

  barClass = currentVal < dividerVal ? 'progress-bar-danger' : 'progress-bar-success';
  $('.progress-bar').addClass(barClass);

  if(maxVal == 0){
    $('.progress-val strong').html('');
  }

  if(dividerVal == 0){
    $('.divider-progress').html('');
  }

  if(currentVal == 0){
    $('.progress-current').html('');
  }
}

$(document).on('click', '#census_employee_search_clear', function() {
  $('form#census_employee_search input#employee_search').val('');
  $("form#census_employee_search").submit();
})

$(document).on('change', '#address_info .office_kind_select select', function() {
  if ($(this).val() == 'mailing') {
    $(this).parents('fieldset').find('#phone_info input.area_code').attr('required', false);
    $(this).parents('fieldset').find('#phone_info input.phone_number7').attr('required', false);
  };
  if ($(this).val() == 'primary' || $(this).val() == 'branch'){
    $(this).parents('fieldset').find('#phone_info input.area_code').attr('required', true);
    $(this).parents('fieldset').find('#phone_info input.phone_number7').attr('required', true);
  };
  if ($(this).val() == 'primary') {
    $(this).parents('fieldset').find(".county-select").addClass('primary-office-location');
  }
  else {
    $(this).parents('fieldset').find(".county-select").removeClass('primary-office-location');
  }
})

function checkPhone(textbox) {
  var phoneRegex = /^\d{3}-\d{4}$/;
  if (textbox.value == '') {
    textbox.setCustomValidity('Please fill out this phone number field.');
  } else if(!phoneRegex.test(textbox.value)){
    textbox.setCustomValidity('please enter a valid phone number.');
  } else {
    textbox.setCustomValidity('');
  }
  return true;
}

function checkZip(textbox) {
  var zipRegex = /^\d{5}$/;
  if (textbox.value == '') {
    textbox.setCustomValidity('Please fill out this zipcode field.');
  } else if(!zipRegex.test(textbox.value)){
    textbox.setCustomValidity('please enter a valid zipcode.');
  } else {
    textbox.setCustomValidity('');
    if ($('.county-select').length > 0) {
      var child_index = $(textbox).data('child-index');
      $.ajax({
        type: 'get',
        datatype: 'js',
        url: '/employers/employer_profiles/counties_for_zip_code',
        data: { zip_code: textbox.value },
        success: function (response) {
          /*
          $('#county-select-' + child_index + " select").html(response);
          $('#organization_office_locations_attributes_0_address_attributes_county').get(0).setCustomValidity('');
          if (!$('#organization_office_locations_attributes_0_address_attributes_county').val() &&
                  $("#organization_office_locations_attributes_0_address_attributes_county option[value='Zip code outside MA']").length === 0)
          {
              $('#organization_office_locations_attributes_0_address_attributes_county').get(0).setCustomValidity('Please select county.');
          }*/
        }
      });
    }
  }
  return true;
}

function validateCounty(selectField) {
    if (!$('#organization_office_locations_attributes_0_address_attributes_county').val())
    {
        $('#organization_office_locations_attributes_0_address_attributes_county').get(0).setCustomValidity('Please select county.');
    } else {
        $('#organization_office_locations_attributes_0_address_attributes_county').get(0).setCustomValidity('');
    }
}

$(document).on('submit', '#new_organization', function() {
  var retVal = true;
  if ($("#organization_sic_code").length && !$("#organization_sic_code option:selected").val())
  {
    $("#sic_warning").html('Please fill Standard Indusry Code');
    retVal = false;
  }
  return retVal;
});

function checkAreaCode(textbox) {
  var phoneRegex = /^\d{3}$/;
  if (textbox.value == '') {
    textbox.setCustomValidity('Please fill out this area code field.');
  } else if(!phoneRegex.test(textbox.value)){
    textbox.setCustomValidity('please enter a valid area code.');
  } else {
    textbox.setCustomValidity('');
  }
  return true;
}
