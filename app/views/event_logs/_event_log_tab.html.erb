<style lang="scss">
  .filters-container {
    margin-bottom: 10px;
  }

  .filters-toggle {
    cursor: pointer;
    padding: 5px;
    margin-bottom: 10px;
  }

  .filters-text {
    color: #323130;
    font-size: 18px;
    font-style: normal;
    font-weight: 700;
    line-height: 27px;
  }

  .filters {
    display: none;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 10px;
    gap: 12px;
  }

  .filter-row {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }

  .filter-row label {
    color: #605E5C;
    font-size: 16px;
    font-style: normal;
    font-weight: 600;
    line-height: 24px;
  }

  .filter-row input,
  .filter-row select {
    display: flex;
    padding: 10px 8px;
    align-items: center;
    gap: 8px;
    align-self: stretch;
    border-radius: 3px;
    border: 1px solid #8E8A86;
    background: #FFF;
  }

  #eligibility {
    width: 200px;
  }

  #run-query {
    padding: 10px;
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
    display: block; /* Ensure the button is a block element to start on a new line */
    margin-top: 10px; /* Adjust the margin as needed */
  }

  div.filters .selectric .label {
    width: 200px !important;
  }

  #export-table {
    padding: 10px;
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
    margin-left: auto;
  }

  #run-query,
  #export-table {
    display: flex;
    align-items: flex-start;
  }

  .event-log-header.h3 {
    color: #323130;
    font-size: 24px;
    font-style: normal;
    font-weight: 700;
    line-height: 36px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  th, td {
    padding: 8px;
    text-align: left;
  }

  th.sortable:hover {
    cursor: pointer;
    text-decoration: underline;
  }

  .display-none {
    display: none;
  }

  .event-with-arrow {
    width: 5%;
  }

  .event-col-2, .event-col-3 {
    width: 20%;
  }

  .event-col-4 {
    width: 35%;
  }

  .event-col-4 {
    width: 20%;
  }

  .event-col-5 {
    width: 15%;
  }
</style>

<div class="event-log-tab">
  <div>
    <h1>Audit Log</h1>
    <h2><%= organization.legal_name %></h2>
    <p>HBX ID: <%= @employer_profile.hbx_id %></p>
    <p>Please use the filters below to see specific actions taken on this organization.</p>

    <div class="filters-container">
      <div id="filters-toggle" class="filters-toggle">
        <span class="glyphicon glyphicon-chevron-right" id="filters-arrow"></span>
        <span class="filters-text">Filters</span>
      </div>
      <div class="filters" id="filters">
        <div class="filter-row">
          <label for="eligibility">Eligibility</label>
          <select id="eligibility">
            <option value="OSSE">OSSE Eligibility</option>
          </select>
        </div>
        <div class="filter-row">
          <label for="user-id">HBX User / ID</label>
          <input type="text" id="user-id">
        </div>
        <div class="filter-row">
          <label for="start-date">Start Date Range</label>
          <input type="date" id="start-date">
        </div>
        <div class="filter-row">
          <label for="end-date">End Date Range</label>
          <input type="date" id="end-date" disabled>
        </div>
      </div>
      <div class="run-query">
        <button id="run-query">Run Query</button>
      </div>
    </div>

    <div class="event-log-header">
      <h3><b>Event Log for 105609</b></h3>
      <button id="export-table">Export Table</button>
    </div>
    <div id="event-table-data"></div>
  </div>
</div>

<script>
  $(document).ready(function() {
    const filtersToggle = $('#filters-toggle');
    const filters = $('#filters');
    const arrow = $('#filters-arrow');
    const runQueryButton = $('#run-query');
    const eligibilityFilter = $('#eligibility');
    const userIdFilter = $('#user-id');
    const startDateFilter = $('#start-date');
    const endDateFilter = $('#end-date');

    startDateFilter.on('change', function () {
      const startDate = new Date(startDateFilter.val());
      startDate.setDate(startDate.getDate() + 1);
      endDateFilter.prop('disabled', false);
      endDateFilter.attr('min', formatDate(startDate));
    });

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    filtersToggle.on('click', function(e) {
      const isFiltersHidden = filters.css('display') === 'none';
      filters.css('display', isFiltersHidden ? 'flex' : 'none');
      arrow.toggleClass('glyphicon-chevron-right glyphicon-chevron-down');
      runQueryButton.toggle(isFiltersHidden);
    });

    runQueryButton.hide();

    runQueryButton.on('click', function() {
      $.ajax({
        type: 'POST',
        url: '/event_logs',
        dataType: 'script',
        data: {
          eligibility: eligibilityFilter.val(),
          user_id: userIdFilter.val(),
          start_date: startDateFilter.val(),
          end_date: endDateFilter.val(),
        },
        success: function(response) {
          // Handle success
        },
        error: function(error) {
          // Handle error
          console.error('AJAX call error:', error);
        }
      });
    });

    $('#export-table').on('click', function() {
      window.location.href = '/event_logs.csv';
    });

    $.ajax({
      type: 'POST',
      url: '/event_logs',
      dataType: 'script',
      data: {},
    });
  });
</script>
