<% insured = (current_user.try(:has_consumer_role?) && current_user.consumer_identity_verified?) || current_user.try(:has_employee_role?) %>
<% employer_staff =  (current_user.person && current_user.person.active_employer_staff_roles) || []%>
<% employer = employer_staff.first %>
<% broker_staff_roles =  (current_user.person && current_user.person.active_broker_staff_roles) || []%>
<% ga_staff_roles =  (current_user.person && current_user.person.active_general_agency_staff_roles) || []%>
<% roles = [insured] %>
<% portal_count = roles.select{|role|role}.count + employer_staff.count + broker_staff_roles.count + ga_staff_roles.count%>

<% if ::EnrollRegistry.feature_enabled?(:manage_account_functionality) %>
  <span>
   <a href="#" class="dropdown-toggle" id="dropdownMenuLink"  data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" onclick="myFunction()" ><i class="fas fa-bars"></i> <strong><%= user_first_name_last_name_and_suffix %></strong></a>

    <ul class="dropdown-menu hub-menu" aria-labelledby="dropdownMenuLink">
      <% if current_user.person.present? %>
        <li style="text-align: center; padding-top: 5px;">
          <i class="fas fa-question-circle fa-lg fa-2x"></i>
          <div>
            <h4> <%= l10n("hub.hamburgermenu.title") %> </h4>
          </div>
          <div style="text-align: left;">
            <div style="padding-left: 10px;">
              <p><small><%= l10n("hub.hamburgermenu.description1") %> <span style="border-bottom: 1px dotted #000;" title="<%= l10n("hub.hamburgermenu.description.tooltip") %>"><%= l10n("hub.hamburgermenu.description2") %></span><%= l10n("hub.hamburgermenu.description3") %> <strong><%= l10n("hub.home_page.title") %></strong></small></p>
            </div>
            <div class="hub-link">
              <%= link_to "#{l10n('hub.hamburgermenu.hub_link')}", main_app.show_roles_person_path(current_user.person) %>
            </div>
            <div style="padding-left: 10px;">
              <small><%= l10n("hub.hamburgermenu.currently_viewing") %></small>
              <p><%= session[:current_portal]&.html_safe %></p>
            </div>
          </div>
        </li>
      <% end %>
    </ul>
  </span>
<% else %>
  <% if portal_count == 1 %>
    <span>
      <%= link_to l10n(".my_insured_portal"), main_app.family_account_path(tab: 'home'), class: 'header-text' if insured %>
      <%= link_to l10n('.my_employer_portal'), benefit_sponsors.new_profiles_registration_path(:profile_type => :benefit_sponsor), class: 'header-text' if employer_staff.present? %>
      <%= link_to l10n('.my_broker_agency_portal'), benefit_sponsors.new_profiles_registration_path(:profile_type => :broker_agency), class: 'header-text' if broker_staff_roles.any? %>
      <%= link_to l10n('.my_general_agency_portal'), benefit_sponsors.profiles_general_agencies_general_agency_profile_path(ga_staff_roles.first.general_agency_profile, tab:'home'), class: 'header-text' if ga_staff_roles.any? %>
      <span> | </span>
    </span>
  <%elsif portal_count > 1 %>
    <span>
      <a href="#" class="dropdown-toggle header-text" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">My Portals <span class="caret"></span></a>
      <ul class="dropdown-menu">
        <% if current_user.hints == true %>
          <li>
            <i class="fa fa-question-circle fa-3x text-center" aria-hidden="true" style="display: block;"></i>
            <h3 class="darkblue no-buffer text-center">Did You Know?</h3>
              <div class="panel panel-default">
                <div class="panel-body">You can move between your insured, employer, broker accounts using this My Portals link.</div>
              </div>
          </li>
        <% end %>
        <% if insured %>
          <li><%= link_to l10n('.my_insured_portal'), main_app.family_account_path(tab: 'home'), class: 'header-text' %></li>
        <% end %>
        <% employer_staff.each do |employer_staff_role|  %>
          <% id = employer_staff_role.benefit_sponsor_employer_profile_id %>
            <% employer = BenefitSponsors::Organizations::Profile.find(id) %>
            <li><%= link_to employer.organization.legal_name, benefit_sponsors.profiles_employers_employer_profile_path(employer, tab: 'home'), class: 'header-text' %></li>
        <% end %>
        <% broker_staff_roles.each do |broker_staff_role| %>
          <%profile = broker_staff_role.broker_agency_profile%>
          <% if profile.is_a? BenefitSponsors::Organizations::BrokerAgencyProfile %>
            <% broker_link = benefit_sponsors.profiles_broker_agencies_broker_agency_profile_path(profile, tab:'home') %>
          <% else %>
            <% #backwards compatibility with old model %>
            <% broker_link =  main_app.broker_agencies_profile_path(profile) %>
          <% end %>
          <li style="text-align:left"><%= link_to profile.legal_name, broker_link, class: 'header-text' %></li>
        <% end %>
        <% ga_staff_roles.each do |ga_staff_role| %>
          <%profile = ga_staff_role.general_agency_profile%>
          <% if profile.is_a? BenefitSponsors::Organizations::GeneralAgencyProfile %>
            <% ga_link = benefit_sponsors.profiles_general_agencies_general_agency_profile_path(profile, tab:'home') %>
          <% else %>
            <% ga_link =  main_app.general_agencies_profile_path(profile) %>
          <% end %>
          <li style="text-align:left"><%= link_to profile.legal_name, ga_link, class: 'header-text' %></li>
        <% end %>
      </ul>
      <span> | </span>
    </span>
  <% end %>
  <%= user_first_name_last_name_and_suffix %>
<% end %>

<style type="text/css">
  .hub-menu {
    min-width: 15rem;
    border: 1px solid #007bc4;
  }

  .hub-link {
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 2px solid rgba(0, 0, 0, 0.1);
    padding: 10px;
  }
</style>
