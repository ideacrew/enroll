namespace :employer_invoice do
  desc "Generates Invoices for Initial and Conversion Employers"
  task generate: :environment do

    DO_NOT_INVOICE_LIST = [464303739, 521322260, 521185005, 521021282, 510400233,
      521961415, 530196563, 270360045, 522094677, 231520302, 272141277, 931169142,
      522062304, 550864322, 621469595, 521795954, 522324745, 273300538, 264064164,
      28, 363697513, 200714211, 200850720, 451221231, 202853236, 201743104, 131954338,
      521996156, 520746264, 260839561, 204098898, 521818188, 42751357, 521811081,
      521782065, 237400898, 830353971, 742994661, 522312249, 521498887, 261332221,
      521016137, 452400752, 521103582, 360753125, 710863908, 521309304, 522022029,
      522197080 ,521826332]

    @folder_name="DCEXCHANGE_#{TimeKeeper.date_of_record.strftime("%Y%m%d")}"
    
  	conversion_employers= Organization.where({
    :'employer_profile.profile_source' => 'conversion',
    :'employer_profile.plan_years' => { 
      :$elemMatch => {
          :"start_on" => { "$eq" => DateTime.parse("2016-07-01" ) } ,
          :"aasm_state".in =>  PlanYear::RENEWING_PUBLISHED_STATE 
        }
      }
    })

    new_employers = Organization.where({
      :'employer_profile.plan_years' => { 
       :$elemMatch => {
         :start_on =>  { "$eq" => DateTime.parse("2016-07-01" ) },
         :"aasm_state".in => PlanYear::PUBLISHED
       }}
    })

    generate_invoices(conversion_employers, false)
    generate_invoices(new_employers, true)
   
    #Create a tar file 
    puts "creating a tar file now"
    	system("tar -zcvf #{@folder_name}.tar.gz #{@folder_name}")
    puts "Folder created!"

  end

  def generate_invoices(organizations, clean_up = nil )
    organizations.each do |org|
      unless DO_NOT_INVOICE_LIST.include?(org.fein) || !org.employer_profile.plan_years.renewing.first.try(:is_enrollment_valid?)
        if clean_up
          employer_invoice = EmployerInvoice.new(org,@folder_name)
          employer_invoice.save_and_notify_with_clean_up
        else
          employer_invoice = EmployerInvoice.new(org,@folder_name)
          employer_invoice.save_and_notify
        end
      end
    end
  end

  desc "Generates Invoices for Conversion Employers, given FEIN"
  task generate_by_fein: :environment do

    @folder_name="DCEXCHANGE_#{TimeKeeper.date_of_record.strftime("%Y%m%d")}"

    INVOICE_LIST_BY_FEIN = [
      "521131199","455373892","203977558","020769309","134249543","521764344","999999995","520781390","521231983","530196567","084462763",
      "870745629","132581875","520845718","202305292","264442148","326166948","362340300","200915207","521091718","941450490","942763845",
      "133914342","202926200","522032499","273175119","202990791","522289343","581557556","530191635","273980558","522334463","204865805",
      "271976324","260832862","020785811","954163931","202187349","521282103","311766444","264127579","522321361","520941367","521644571",
      "530207408","521633220","261799321","530258392","264094042","521173228","520966285","042992565","521239804","530078064","521629385",
      "470975519","530259978","711019574","208146088","261392682","522075691","521891162","364778585","521088411","521854633","201799842",
      "261607955","237218916","000000031","134229575","521385018","300168697","264787596","522077951","521428669","000000029","000000023",
      "521979573","237185827","462416858","263987744","522228944","943438751","521602643","530210664","263155690","432017324","522141499",
      "262903088","522003122","521929169","260126537","711045354","202130493","521793723","260077227","522250839","273443167","521909847",
      "203380456","000000024","262113110","522202731","260204031","542073913","521298659","273281915","521925788","521164983","521104567",
      "521447196","520986261","202700607","133711840","421693698","541487512","521690303","810635596","331096765","521168827","200118307",
      "454026252","521807436","522279789","451657406","263463204","611558833","521782312","421719040","522287851","521768183","530259837",
      "363832940","237451661","911568650","953927141","521218832","522086855","237347351","135544472","521268692","521473117","530182304",
      "237447365","522005999","272942781","520909444","541748419","521740146","521586114","463346460","522013356","541719573","870803909",
      "942716768","261126743","453836904","521687743","522165679","522071979","520899578","223980819","520939363","030480309","530204690",
      "371635320","520986797","204073133","521792575","541935838","200799914","521209527","264032886","541824478","264573463","520858068",
      "521666904","452398600","020767157","621440640","521954273","237367533","521474935","521471376","521104809","900436782","521684389",
      "261715929","273369694","521473769","526046203","330147824","237147887","530224276","465096233","521505364","205258714","520807696",
      "202037984","521905865","521279682","521557819","521480202","130615840","521645512","521722025","200482817","520741350","202458375",
      "202468102","521801489","208446765","541965828","452375150","363976313","521294659","542051425","541394025","522217020","900536785",
      "521156410","522336694","522181533","521380506","471109600","521209825","043677636","522100597","521323437","521594479","455616367"]

    organizations = Organization.where(:"fein".in => INVOICE_LIST_BY_FEIN)
    organizations.each do |org|
      employer_invoice = EmployerInvoice.new(org,@folder_name)
      employer_invoice.save_and_notify
    end
    puts "creating a tar file now"
      system("tar -zcvf #{@folder_name}.tar.gz #{@folder_name}")
    puts "Folder created!"
  end
end
