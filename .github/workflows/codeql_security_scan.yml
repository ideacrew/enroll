name: CodeQL Security Scan
on:
  push:
  workflow_dispatch:

concurrency:
  group: codeql-s-scan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  codeql-scan:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2
        - name: Install CodeQL
          run: |
            cd $HOME
            wget https://github.com/github/codeql-action/releases/download/codeql-bundle-v2.17.1/codeql-bundle-linux64.tar.gz
            tar xzvf codeql-bundle-linux64.tar.gz
        - name: Setup CodeQL
          run: |
            export PATH=$PATH:$HOME/codeql
            ./codeql/install_codeql.sh
        - name: Build CodeQL Database
          run: |
            export PATH=$PATH:$HOME/codeql
            ./codeql/build_db.sh
        - name: Create CodeQL Sarif Reports
          run: |
            export PATH=$PATH:$HOME/codeql
            ./codeql/create_codeql_report.sh
        - name: Analyze Reports
          run: |
            cd codeql/sarif_reporter/
            npm install
            npm run compile
            cat ../../codeql.json | npm run-script run